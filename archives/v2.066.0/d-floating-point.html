
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">

<!--
    Copyright (c) 1999-2017 by Digital Mars
    All Rights Reserved Written by Walter Bright
    http://digitalmars.com
  -->

<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="keywords" content="D programming language" />
<meta name="description" content="D Programming Language" />
<title>Real Close to the Machine: Floating Point in D - D Programming Language</title>
<link rel="stylesheet" href="css/codemirror.css" />
<link rel="stylesheet" type="text/css" href="css/style.css" />
<link rel="stylesheet" type="text/css" href="css/print.css" media="print" />
<link rel="shortcut icon" href="favicon.ico" />

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script src="js/codemirror-compressed.js"></script>
<script src="js/run-main-website.js" type="text/javascript"></script>
<script src="js/run.js" type="text/javascript"></script>

<script type="text/javascript">
function bodyLoad()
{
    var links = document.getElementById("navigation").getElementsByTagName("a");
    for (var i = 0; i < links.length; i++)
    {
        var url = "/" + links[i].getAttribute("href");
        if (window.location.href.match(url + "\x24") == url)
        {
            var cls = links[i].getAttribute("class");
            links[i].setAttribute("class", cls ? cls + " active" : "active");
            break;
        }
    }
}
</script>
</head>

<body onLoad='bodyLoad()'>

<div id="top">
    <div id="search-box">
        <form method="get" action="http://google.com/search">
            <img src="images/search-left.gif" width="11" height="22" /><input id="q" name="q" /><input type="image" id="search-submit" name="submit" src="images/search-button.gif" />
            <input type="hidden" id="domains" name="domains" value="dlang.org" />
            <input type="hidden" id="sourceid" name="sourceid" value="google-search" />
            <div id="search-dropdown">
                <select id="sitesearch" name="sitesearch" size="1">
                    <option value="dlang.org">Entire D Site</option>
                    <option value="dlang.org/phobos">Library Reference</option>
                    <option value="digitalmars.com/d/archives">Newsgroup Archives</option>
                </select>
            </div>
        </form>
    </div>
    <div id="header">
        <a id="d-language" href="/">
        <img id="logo" width="125" height="95" border="0" alt="D Logo" src="images/dlogo.png">
        D Programming Language</a>
    </div>
</div>

<!--Generated by Ddoc from d-floating-point.dd-->



<div id="navigation">
  

<div class="navblock">
<h2><a href="index.html" title="D Programming Language">D 2.066.0</a></h2>
<ul>    <li><a href="overview.html" title="D language overview">Overview</a></li>
    <li><a href="comparison.html" title="D feature list">Features</a></li>
    <li><a href="download.html" title="Download a D compiler">Downloads &amp; Tools</a></li>
    <li><a href="changelog.html" title="History of changes to D">Change Log</a></li>
    <li><a href="bugstats.php" title="D issue and bug tracking system">Bug Tracker</a></li>
    <li><a href="faq.html" title="Frequently Asked Questions">FAQ</a></li>
    <li><a href="appendices.html">Appendices</a></li>
    <li><a href="acknowledgements.html" title="Thank-you to these people who have helped with D">Acknowledgments</a></li>
    <li><a href="sitemap.html" title="Documents on this site, indexed alphabetically">Sitemap</a></li>
    <li><a href="http://digitalmars.com/d/1.0/index.html" title="D Programming Language 1.0">D1 Home</a></li>
</ul>
    </div>

<div class="navblock">
<h2>Documentation</h2>
<ul>    <li><a href="http://ddili.org/ders/d.en/index.html">Online Book (free)</a></li>
    <li><a href="http://wiki.dlang.org/Books" title="D Programming Language Books">More Books</a></li>

    <li><a href="language-reference.html">Language Reference</a></li>
    <li><a href="phobos/index.html">Library Reference</a></li>
    <li><a href="library/index.html">&nbsp;<font size=-1><span style="visibility: hidden">3</span>Preview new Layout</font></a></li>

    <li><a href="howtos.html" title="Helps for using D">How-tos</a></li>
    <li><a href="articles.html">Articles</a>

    <div class="navblock">
<ul>        <li><a href="const3.html" title="Const and Immutable">Const</a></li>
        <li><a href="d-floating-point.html" title="D Floating Point">Floating Point</a></li>
        <li><a href="exception-safe.html" title="Exception safe programming techniques">Exception Safety</a></li>
        <li><a href="hijack.html" title="Function Hijacking Mitigation">Hijacking</a></li>
        <li><a href="intro-to-datetime.html" title="Introduction to std.datetime">Introduction to std.datetime</a></li>
        <li><a href="lazy-evaluation.html" title="Lazy evaluation of function arguments">Lazy Evaluation</a></li>
        <li><a href="memory.html" title="Memory management techniques in D">Memory Management</a></li>
        <li><a href="migrate-to-shared.html" title="Migrating to Shared">Migrating to Shared</a></li>
        <li><a href="mixin.html" title="String mixins compile string literals into D programs">Mixins</a></li>
        <li><a href="regular-expression.html" title="Programming with regular expressions">Regular Expressions</a></li>
        <li><a href="safed.html" title="SafeD - The Safe Subset of D">SafeD</a></li>
        <li><a href="templates-revisited.html" title="D takes a fresh look at template design">Templates Revisited</a></li>
        <li><a href="tuple.html" title="What tuples are and how to use them">Tuples</a></li>
        <li><a href="variadic-function-templates.html" title="Variadic arguments to templates">Variadic Templates</a></li>
        <li><a href="d-array-article.html" title="D Slices">D Slices</a></li>
    </ul>
</div></li>
</ul>
    </div>

<div class="navblock">
<h2><a href="http://rainers.github.io/visuald/visuald/StartPage.html">Visual D</a></h2>
<ul></ul>
    </div>

<div class="navblock">
<h2>Community</h2>
<ul>    <li><a href="http://forum.dlang.org/" title="User forums">Forums</a></li>
    <li><a href="http://github.com/D-Programming-Language" title="D on github">GitHub</a></li>
    <li><a href="http://wiki.dlang.org" title="Wiki for the D Programming Language">Wiki</a></li>
    <li><a href="http://wiki.dlang.org/Review_Queue" title="Queue of current and upcoming standard library additions">Review Queue</a></li>
    <li><a href="http://code.dlang.org" title="Third party packages written in D">Third Party Packages</a></li>
    <li><a href="http://twitter.com/#search?q=%23d_lang" title="#d_lang on twitter.com">Twitter</a></li>
    <li><a href="http://digitalmars.com/d/dlinks.html" title="External D related links">Links</a></li>
    
</ul>
    </div>
  
<div id="translate" class="tool">Translate this page:
    <div id="google_translate_element"></div><script type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'en',
        autoDisplay: false,
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      }, 'google_translate_element');
    }
    </script>
<script type="text/javascript" src="http://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</div>
</div><!--/navigation-->
<div id="content" class='hyphenate'>
  
<div id="tools">
    <!--span id="lastupdate">Last update (no date time)</span-->
    <span class="tip">
        <a href="https://github.com/D-Programming-Language/dlang.org/edit/master/d-floating-point.dd" class="button">Improve this page</a>
        <span>
            Quickly fork, edit online, and submit a pull request for this page.
            Requires a signed-in GitHub account. This works well for small changes.
            If you'd like to make larger changes you may want to consider using
            local clone.
        </span>
    </span>
    <span class="tip">
        <a href="http://wiki.dlang.org/DocComments/FloatingPointInD" class="button">Page wiki</a>
        <span>
            View or edit the community-maintained wiki page associated with this page.
        </span>
    </span>
</div>
  <h1>Real Close to the Machine: Floating Point in D</h1>
  
<h2>Introduction</h2>

<p><i>by Don Clugston</i></p>

<p>Computers were originally conceived as devices for performing mathematics. The earliest computers spent most of their time solving equations. Although the engineering and scientific community now forms only a miniscule part of the computing world, there is a fantastic legacy from those former times: almost all computers now feature superb hardware for performing mathematical calculations accurately and extremely quickly. Sadly, most programming languages make it difficult for programmers to take full advantage of this hardware. An even bigger problem is the lack of documentation; even for many mathematical programmers, aspects of floating-point arithmetic remain shrouded in mystery.
</p>

<p>As a systems programming language, the D programming language attempts to remove all barriers between the programmer and the compiler, and between the programmer and the machine. This philosophy is particularly evident in support for floating-point arithmetic. A personal anecdote may illustrate the importance of having an accurate understanding of the hardware.
</p>

<p>My first floating-point nightmare occurred in a C++ program which hung once in every hundred runs or so. I eventually traced the problem to a while loop which occasionally failed to terminate. The essence of the code is shown in Listing 1.
</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">double</span> q[8];
...
<span class="d_keyword">int</span> x = 0;
<span class="d_keyword">while</span> (x &lt; 8) {
  <span class="d_keyword">if</span> ( q[x] &gt;= 0 ) <span class="d_keyword">return</span> <span class="d_keyword">true</span>;
  <span class="d_keyword">if</span> ( q[x] &lt; 0 ) ++x;
}
<span class="d_keyword">return</span> <span class="d_keyword">false</span>;
</span></pre>

<p>Initially, I was completely baffled as to how this harmless-looking loop could fail. But eventually, I discovered that q had not been initialized properly; q[7] contained random garbage. Occasionally, that garbage had every bit set, which mean that q[7] was a Not-a-Number (NaN), a special code which indicates that the value of the variable is nonsense. NaNs were not mentioned in the compiler's documentation - the only information I could find about them was in Intel's assembly instruction set documentation! Any comparison involving a NaN is false, so q[7] was neither &gt;= 0, nor &lt; 0, killing my program. Until that unwelcome discovery, I'd been unaware that NaNs even existed. I had lived in a fool's paradise, mistakenly believing that every floating point number was either positive, negative, or zero.
</p>

<p>My experience would have been quite different in D. The "strange" features of floating point have a higher visibility in the language, improving the education of numerical programmers.
Uninitialized floating point numbers are initialized to NaN by the compiler, so the problematic loop would fail every time, not intermittently.
Numerical programmers in D will generally execute their programs with the 'invalid' floating point exception enabled. Under those circumstances, as soon as the program accessed the uninitialized variable, a hardware exception would occur, summoning the debugger.
Easy access to the "strange" features of floating point results in better educated programmers, reduced confusion, faster debugging, better testing, and hopefully, more reliable and correct numerical programs.
This article will provide a brief overview of the support for floating point in the D programming language.
</p>

<h2>Demystifying Floating-Point</h2>

<p>D guarantees that all built-in floating-point types conform to IEEE 754 arithmetic, making behaviour entirely predictable (note that this is <i>not</i> the same as producing identical results on all platforms). IEEE 754-2008 is the latest revision of the IEEE 754 Standard for Floating-Point Arithmetic. D is progressing towards full compliance with 754-2008.</p>

<p>The IEEE standard floating point types currently supported by D are <span class="notranslate"><span class="d_inlinecode donthyphenate">float</span></span> and <span class="notranslate"><span class="d_inlinecode donthyphenate">double</span></span>. Additionally, D supports the <span class="notranslate"><span class="d_inlinecode donthyphenate">real</span></span> type, which is either 'IEEE 80-bit extended' if supported by the CPU; otherwise, it is the same as <span class="notranslate"><span class="d_inlinecode donthyphenate">double</span></span>. In the future, the new types from 754-2008 will be added: <span class="notranslate"><span class="d_inlinecode donthyphenate">quadruple</span></span>, <span class="notranslate"><span class="d_inlinecode donthyphenate">decimal64</span></span>, and <span class="notranslate"><span class="d_inlinecode donthyphenate">decimal128</span></span>.</p>

<p>The characteristics of these types are easily accessible in the language via <i>properties</i>. For example, <span class="notranslate"><span class="d_inlinecode donthyphenate">float.max</span></span> is the maximum value which can be stored in a float; <span class="notranslate"><span class="d_inlinecode donthyphenate">float.mant_dig</span></span> is the number of digits (bits) stored in the mantissa.</p>

<p>To make sense of mathematics in D, it's necessary to have a basic understanding of IEEE floating-point arithmetic. Fundamentally, it is a mapping of the infinitely many real numbers onto a small number of bytes. Only 4000 million distinct numbers are representable as an IEEE 32-bit float. Even with such a pathetically small representation space, IEEE floating point arithmetic does a remarkably good job of maintaining the illusion that mathematical real numbers are being used; but it's important to understand when the illusion breaks down.</p>

<p>Most problems arise from the distribution of these representable numbers. The IEEE number line is quite different to the mathematical number line.</p>

<pre class="d_code"><span class="notranslate">
     +     +-----------+------------+    ..   +    ..    +----------+----------+     +       #
-infinity -<span class="d_keyword">float</span>.max  -1  -<span class="d_keyword">float</span>.min_normal   0   <span class="d_keyword">float</span>.min_normal  1  <span class="d_keyword">float</span>.max infinity  NaN

</span></pre>

<p>Notice that half of the IEEE number line lies between -1 and +1. There are 1000 million representable floats between 0 and 0.5, but only 8 million between 0.5 and 1. This has important implications for accuracy: the effective precision is incredibly high near zero. Several examples will be presented where numbers in the range -1 to +1 are treated seperately to take advantage of this.</p>

<p>Notice also the special numbers: &plusmn;&infin;; the so-called "subnormals" between &plusmn;float.min_normal and 0, which are represented at reduced precision; the fact that there are TWO zeros, +0 and -0, and finally "NaN"("Not-a-Number"), the nonsense value, which caused so much grief in Listing 1.</p>

<p>Why does NaN exist? It serves a valuable role: it <i>eradicates undefined behaviour</i> from floating-point arithmetic. This makes floating-point completely predictable. Unlike the <span class="notranslate"><span class="d_inlinecode donthyphenate">int</span></span> type, where 3/0 invokes a hardware division by zero trap handler, possibly ending your program, the floating-point division 3.0/0.0 results in &infin;. Numeric overflow (eg, <span class="notranslate"><span class="d_inlinecode donthyphenate">real.max*2</span></span>) also creates &infin;. Depending on the application, &infin; may be a perfectly valid result; more typically, it indicates an error. Nonsensical operations, such as <span class="notranslate"><span class="d_inlinecode donthyphenate">0.0 / 0.0</span></span>, result in NaN; but <i>your program does not lose control</i>. At first glance, infinity and NaN may appear unnecessary -- why not just make it an error, just as in the integer case? After all, it is easy to avoid division by zero, simply by checking for a zero denominator before every division. The real difficulty comes from overflow: it is extremely difficult to determine in advance whether an overflow will occur in a multiplication.</p>

<p>Subnormals are necessary to prevent certain anomalies, and preserve important relationships such as: "x - y == 0 if and only if x == y".</p>

<p>Since &infin; can be produced by overflow, both +&infin; and -&infin; are required. Both +0 and -0 are required in order to preserve identities such as: if <span class="notranslate"><span class="d_inlinecode donthyphenate">x&gt;0</span></span>, then <span class="notranslate"><span class="d_inlinecode donthyphenate">1/(1/x) &gt; 0</span></span>. In almost all other cases, however, there is no difference between +0 and -0.</p>

<p>It's worth noting that these &lsquo;special values&rsquo; are usually not very efficient. On x86 machines, for example, a multiplication involving a NaN, an infinity, or a subnormal can be twenty to fifty times slower than an operation on normal numbers. If your numerical code is unexpectedly slow, it's possible that you are inadvertently creating many of these special values. Enabling floating-point exception trapping, described later, is a quick way to confirm this.</p>

<p>One of the biggest factor obscuring what the machine is doing is in the conversion between binary and decimal. You can eliminate this by using the <span class="notranslate"><span class="d_inlinecode donthyphenate">"%a"</span></span> format when displaying results. This is an invaluable debugging tool, and an enormously helpful aid when developing floating-point algorithms. The <span class="notranslate"><span class="d_inlinecode donthyphenate">0x1.23Ap+6</span></span> hexadecimal floating-point format can also be used in source code for ensuring that your input data is <i>exactly</i> what you intended.</p>

<h2>The Quantized Nature of Floating-Point</h2>

<p>The fact that the possible values are limited gives access to some operations which are not possible on mathematical real numbers. Given a number x,
<span class="notranslate"><span class="d_inlinecode donthyphenate">nextUp(x)</span></span> gives the next representable number which is greater than x.
<span class="notranslate"><span class="d_inlinecode donthyphenate">nextDown(x)</span></span> gives the next representable number which is less than x.
</p>

<p>Numerical analysts often describe errors in terms of "units in the last place"(ulp), a surprisingly subtle term which is often used rather carelessly. [footnote:
The most formal definition is found in [J.-M. Muller, "On the definition of ulp(x)",INRIA Technical Report 5504 (2005).]: If <span class="notranslate"><span class="d_inlinecode donthyphenate">x</span></span> is a real number that lies between two finite consecutive floating-point numbers a and b of type F, without being equal to one of them, then ulp(x)=abs(b-a); otherwise ulp(x) = <span class="notranslate"><span class="d_inlinecode donthyphenate">x*F.epsilon</span></span>. Moreover, ulp(NaN) is NaN, and ulp(&plusmn;F.infinity) = &plusmn;<span class="notranslate"><span class="d_inlinecode donthyphenate">F.max*F.epsilon</span></span>.]
I prefer a far simpler definition: The difference in ulps between two numbers x and y is is the number of times which you need to call nextUp() or nextDown() to move from x to y. [Footnote: This will not be an integer if either x or y is a real number, rather than a floating point number.]
The D library function <span class="notranslate"><span class="d_inlinecode donthyphenate">feqrel(x, y)</span></span> gives the number of bits which are equal between x and y; it is an easy way to check for loss-of-precision problems.
</p>

<p>The quantized nature of floating point has some interesting consequences.</p>

<ul><li>ANY mathematical range [a,b), (a,b], or (a,b) can be converted into a range
or the form [a,b]. (The converse does not apply: there is no (a,b)
equivalent to [-&infin;, &infin;]).</li>
<li>A naive binary chop doesn't work correctly. The fact that there are hundreds or thousands of times as many representable numbers between 0 and 1, as there are between 1 and 2, is problematic for divide-and-conquer algorithms. A naive binary chop would divide the interval [0 .. 2] into [0 .. 1] and [1 .. 2]. Unfortunately, this is not a true binary chop, because the interval [0 .. 1] contains more than 99% of the representable numbers from the original interval!</li>
</ul>

<h2>Condition number</h2>

<p>Using nextUp, it's easy to approximately calculate the condition number.</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">real</span> x = 0x1.1p13L;
<span class="d_keyword">real</span> u = nextUp(x);

<span class="d_keyword">int</span> bitslost = feqrel(x, u) - feqrel(exp(x), exp(u));
</span></pre>

<p>This shows that at these huge values of x, a one-bit error in x destroys 12 bits of accuracy in exp(x)!
The error has increased by roughly 6000 units in the last place. The condition number is thus 6000 at this value of x.
</p>

<h2>The semantics of float, double, and real</h2>

<p>For the x86 machines which dominate the market, floating point has traditionally been performed on a descendent of the 8087 math coprocessor. These "x87" floating point units were the first to implement IEEE754 arithmetic. The SSE2 instruction set is an alternative for x86-64 processors, but x87 remains the only portable option for floating point 32-bit x86 machines (no 32-bit AMD processors support SSE2).</p>

<p>The x87 is unusual compared to most other floating-point units. It _only_ supports 80-bit operands, henceforth termed "real80". All <span class="notranslate"><span class="d_inlinecode donthyphenate">double</span></span> and <span class="notranslate"><span class="d_inlinecode donthyphenate">float</span></span> operands are first converted to 80-bit, all arithmetic operations are performed at 80-bit precision, and the results are reduced to 64-bit or 32-bit precision if required. This means that the results can be significantly more accurate than on a machine which supports at most 64 bit operations. However, it also poses challenges for writing portable code.
(Footnote: The x87 allows you to reduce the mantissa length to be the same as '<span class="notranslate"><span class="d_inlinecode donthyphenate">double</span></span> or <span class="notranslate"><span class="d_inlinecode donthyphenate">float</span></span>, but it retains the real80 exponent, which means different results are obtained with subnormal numbers. To precisely emulate <span class="notranslate"><span class="d_inlinecode donthyphenate">double</span></span> arithmetic slows down floating point code by an order of magnitude).
</p>

<p>Apart from the x87 family, the Motorola 68K (but not ColdFire) and Itanium processors are the only ones which support 80-bit floating point.</p>

<p>A similar issue relates to the FMA (fused multiply and accumulate) instruction, which is available on an increasing number of processors, including PowerPC, Itanium, Sparc, and Cell. On such processors, when evaluating expressions such as <span class="notranslate"><span class="d_inlinecode donthyphenate">x*y + z</span></span>, the <span class="notranslate"><span class="d_inlinecode donthyphenate">x*y</span></span> is performed at twice the normal precison. Some calculations which would otherwise cause a total loss of precision, are instead calculated exactly.
The challenge for a high-level systems programming language is to create an abstraction which provides predictable behaviour on all platforms, but which nonetheless makes good use of the available hardware.
</p>

<p>D's approach to this situation arises from the following observations:</p>

<ol><li>It is extremely costly performance-wise to ensure identical behaviour on all processors. In particular, it is crippling for the x87.</li>
<li>Very many programs will only run on a particular processor. It would be unfortunate to deny the use of more accurate hardware, for the sake of portability which would never be required.</li>
<li>The requirements for portability and for high precision are never required simultaneously. If <span class="notranslate"><span class="d_inlinecode donthyphenate">double</span></span> precision is inadequate, increasing the precision on only some processors doesn't help.</li>
<li>The language should not be tied to particular features of specific processors. </li>
</ol>

<p>A key design goal is: it should be possible to write code such that, regardless of the processor which is used, the accuracy is never worse than would be obtained on a system which only supports the <span class="notranslate"><span class="d_inlinecode donthyphenate">double</span></span> type.</p>

<p>(Footnote: <span class="notranslate"><span class="d_inlinecode donthyphenate">real</span></span> is close to &lsquo;indigenous&rsquo; in the Borneo proposal for the Java programming language[Ref Borneo]).</p>

<p>Consider evaluating <span class="notranslate"><span class="d_inlinecode donthyphenate">x*y + z*w</span></span>, where <span class="notranslate"><span class="d_inlinecode donthyphenate">x, y, z</span></span> and <span class="notranslate"><span class="d_inlinecode donthyphenate">w</span></span> are double.</p>

<ol><li>double r1 = x * y + z * w;</li>
<li>double a  = x * y; double r2 = a + z * w;</li>
<li>real   b  = x * y; double r3 = b + z * w;</li>
</ol>

<p>Note that during optimisation, (2) and (3) may be transformed into (1), but this is implementation-dependent.
Case (2) is particularly problematic, because it introduces an additional rounding.
</p>

<p>On a "simple" CPU, r1==r2==r3. We will call this value r0.
On PowerPC, r2==r3, but r1 may be more accurate than the others, since it enables use of FMA.
On x86, r1==r3, which may be more accurate than r0, though not as much as for the PowerPC case.
r2, however, may be LESS accurate than r0.
</p>

<p>By using <span class="notranslate"><span class="d_inlinecode donthyphenate">real</span></span> for intermediate values, we are guaranteed that our results are never worse than for a simple CPU which only supports <span class="notranslate"><span class="d_inlinecode donthyphenate">double</span></span>.</p>

<h2>Properties of the Built-in Types</h2>

<p>The fundamental floating-point properties are <span class="notranslate"><span class="d_inlinecode donthyphenate">epsilon</span></span>, <span class="notranslate"><span class="d_inlinecode donthyphenate">min_normal</span></span> and <span class="notranslate"><span class="d_inlinecode donthyphenate">max</span></span>. The six integral properties are simply the log2 or log10 of these three.</p>

<table border=1 cellpadding=4 cellspacing=0><tr><th scope="col">&nbsp;</th> <th scope="col">float</th> <th scope="col">double</th> <th scope="col">real80</th> <th scope="col">quadruple</th> <th scope="col">decimal64</th> <th scope="col">decimal128</th></tr>
<tr><td>epsilon</td> <td>0x1p-23</td> <td>0x1p-52</td> <td>0x1p-63</td> <td>0x1p-112</td> <td>1e-16 (1p-54)</td> <td>1e-34 (1p-113)</td></tr>
<tr><td>[min_normal</td> <td>0x1p-126</td> <td>0x1p-1022</td> <td>0x1p-16382</td> <td>0x1p-16382</td> <td>1e-383</td> <td>1e-6143</td></tr>
<tr><td>..max)</td> <td>0x1p+128</td> <td>0x1p+1024</td> <td>0x1p+16384</td> <td>0x1p+16384</td> <td>1e+385</td> <td>1e+6145</td></tr>
<tr><td colspan=7>binary properties</td></tr>
<tr><td>mant_dig</td> <td>24</td> <td>53</td> <td>64</td> <td>113</td> <td>53</td> <td>112</td></tr>
<tr><td>min_exp</td> <td>-125</td> <td>-1021</td> <td>-16381</td> <td>-16381</td> <td>&nbsp;</td> <td>&nbsp;</td></tr>
<tr><td>max_exp</td> <td>+128</td> <td>+1024</td> <td>+16384</td> <td>+16384</td> <td>&nbsp;</td> <td>&nbsp;</td></tr>
<tr><td colspan=7>decimal properties</td></tr>
<tr><td>dig</td> <td>6</td> <td>15</td> <td>18</td> <td>33</td> <td>16</td> <td>34</td></tr>
<tr><td>min_10_exp</td> <td>-37</td> <td>-307</td> <td>-4932</td> <td>-4932</td> <td>-382</td> <td>-6142</td></tr>
<tr><td>max_10_exp</td> <td>+38</td> <td>+308</td> <td>+4932</td> <td>+4932</td> <td>385</td> <td>+6145</td></tr>
</table>

<p>When writing code which should adapt to different CPUs at compile time, use <span class="notranslate"><span class="d_inlinecode donthyphenate">static if</span></span> with the <span class="notranslate"><span class="d_inlinecode donthyphenate">mant_dig</span></span> property. For example, <span class="notranslate"><span class="d_inlinecode donthyphenate">static if (real.mant_dig==64)</span></span> is true if 80-bit reals are available.
For binary types, the <span class="notranslate"><span class="d_inlinecode donthyphenate">dig</span></span> property gives only the <i>minimum</i> number of valid decimal digits. To ensure that that every representable number has a unique decimal representation, two additional digits are required. Similarly, for decimal numbers, <span class="notranslate"><span class="d_inlinecode donthyphenate">mant_dig</span></span> is a lower bound on the number of valid binary digits.
</p>

<h2>Useful relations for a floating point type <span class="notranslate"><span class="d_inlinecode donthyphenate">F</span></span>, where <span class="notranslate"><span class="d_inlinecode donthyphenate">x</span></span> and <span class="notranslate"><span class="d_inlinecode donthyphenate">y</span></span> are of type <span class="notranslate"><span class="d_inlinecode donthyphenate">F</span></span></h2>

<ul><li>The smallest representable number is <span class="notranslate"><span class="d_inlinecode donthyphenate">F.min_normal * F.epsilon</span></span></li>
<li>Any integer between 0 and <span class="notranslate"><span class="d_inlinecode donthyphenate">(1/F.epsilon)</span></span> can be stored in F without loss of precision.
  <span class="notranslate"><span class="d_inlinecode donthyphenate">1/F.epsilon</span></span> is always a exact power of the base.</li>
<li>If a number <span class="notranslate"><span class="d_inlinecode donthyphenate">x</span></span> is subnormal, <span class="notranslate"><span class="d_inlinecode donthyphenate">x*(1/F.epsilon)</span></span> is normal, and
  <span class="notranslate"><span class="d_inlinecode donthyphenate">exponent(x) = exponent(x*(1/F.epsilon)) - (mant_dig-1)</span></span>.</li>
<li><span class="notranslate"><span class="d_inlinecode donthyphenate">x&gt;0</span></span> if and only if <span class="notranslate"><span class="d_inlinecode donthyphenate">1/(1/x) &gt; 0</span></span>; <span class="notranslate"><span class="d_inlinecode donthyphenate">x&lt;0</span></span> if and only if <span class="notranslate"><span class="d_inlinecode donthyphenate">1/(1/x) &lt; 0</span></span>.</li>
<li>If <span class="notranslate"><span class="d_inlinecode donthyphenate">x-y==0</span></span>, then <span class="notranslate"><span class="d_inlinecode donthyphenate">x==y  &amp;&amp; isFinite(x) &amp;&amp; isFinite(y)</span></span>. Note that if <span class="notranslate"><span class="d_inlinecode donthyphenate">x==y==infinity</span></span>, then <span class="notranslate"><span class="d_inlinecode donthyphenate">isNaN(x-y)</span></span>.</li>
<li><span class="notranslate"><span class="d_inlinecode donthyphenate">F.max * F.min_normal = 4.0</span></span> for binary types, <span class="notranslate"><span class="d_inlinecode donthyphenate">10.0</span></span> for decimal types.</li>
</ul>

<h3> Addition and subtraction</h3>

<ul><li>Some loss of precision occurs with x&plusmn;y if exponent(x)!=exponent(y). The number of digits of precision which are lost is abs(exponent(x)-exponent(y)).</li>
<li>x&plusmn;y has total loss of precision, if and only if
   (1)  <span class="notranslate"><span class="d_inlinecode donthyphenate">abs(x * F.epsilon) &gt; abs(y)</span></span>, in which case x+y == x, x-y == x
or (2)  <span class="notranslate"><span class="d_inlinecode donthyphenate">abs(y * F.epsilon) &gt; abs(x)</span></span>, in which case x+y == y, x-y == -y</li>
<li>Addition is commutative: <span class="notranslate"><span class="d_inlinecode donthyphenate">a + b == b + a</span></span>.</li>
<li>Subtraction is not quite commutative: <span class="notranslate"><span class="d_inlinecode donthyphenate">a - b == -(b - a)</span></span>, but produce +0 and -0 if a==b.</li>
<li>Addition is not associative at all.</li>
</ul>

<h3>Multiplication and division</h3>

<ul><li>Multiplication and division are <i>always</i> at risk of overflow or underflow.
  For any <span class="notranslate"><span class="d_inlinecode donthyphenate">abs(x) &gt; F.epsilon</span></span>, there is at least one finite <span class="notranslate"><span class="d_inlinecode donthyphenate">y</span></span> such that <span class="notranslate"><span class="d_inlinecode donthyphenate">x/y</span></span> will overflow to &infin;.
  For any <span class="notranslate"><span class="d_inlinecode donthyphenate">abs(x) &lt; F.epsilon</span></span>, there is at least one finite <span class="notranslate"><span class="d_inlinecode donthyphenate">y</span></span> such that <span class="notranslate"><span class="d_inlinecode donthyphenate">x/y</span></span> will underflow to zero.
  For any <span class="notranslate"><span class="d_inlinecode donthyphenate">abs(x) &gt; 1</span></span>, there is at least one finite <span class="notranslate"><span class="d_inlinecode donthyphenate">y</span></span> such that <span class="notranslate"><span class="d_inlinecode donthyphenate">x*y</span></span> will overflow to &infin;.
  For any <span class="notranslate"><span class="d_inlinecode donthyphenate">abs(x) &lt; 1</span></span>, there is at least one finite <span class="notranslate"><span class="d_inlinecode donthyphenate">y</span></span> such that <span class="notranslate"><span class="d_inlinecode donthyphenate">x*y</span></span> will underflow to zero.
</li>
<li><span class="notranslate"><span class="d_inlinecode donthyphenate">x*x</span></span> will overflow if <span class="notranslate"><span class="d_inlinecode donthyphenate">abs(x)&gt;sqrt(F.max)</span></span>, and underflow to zero if <span class="notranslate"><span class="d_inlinecode donthyphenate">abs(x) &lt; sqrt(F.min_normal*F.epsilon)</span></span>  </li>
<li>Multiplication is commutative. <span class="notranslate"><span class="d_inlinecode donthyphenate">a * b == b * a</span></span></li>.
<li>Multiplication is not associative in general: <span class="notranslate"><span class="d_inlinecode donthyphenate">a*(b*c) != (a*b)*c</span></span>, because (1) there is a risk of overflow or underflow and (2) <span class="notranslate"><span class="d_inlinecode donthyphenate">b*c</span></span> may be an exact calculation, so that <span class="notranslate"><span class="d_inlinecode donthyphenate">a*(b*c)</span></span> contains only one round-off error, whereas <span class="notranslate"><span class="d_inlinecode donthyphenate">(a*b)*c</span></span> contains two. The roundoff errors may therefore accumulate at the rate of just under 1 ulp per multiplication.</li>
<li>However, a limited form of associativity is possible if the type used for intermediate results is larger than any of the operands (which happens on x87 and Itanium machines). If <span class="notranslate"><span class="d_inlinecode donthyphenate">R</span></span> is the intermediate type, and <span class="notranslate"><span class="d_inlinecode donthyphenate">F</span></span> is the type being multiplied, up to <span class="notranslate"><span class="d_inlinecode donthyphenate">min(R.max_exp/F.max_exp, R.epsilon/F.epsilon)</span></span> values of type <span class="notranslate"><span class="d_inlinecode donthyphenate">F</span></span> can be multiplied together in any order without influencing the result. For example, if <span class="notranslate"><span class="d_inlinecode donthyphenate">R</span></span> is <span class="notranslate"><span class="d_inlinecode donthyphenate">double</span></span>, multiplication of 8 floats <span class="notranslate"><span class="d_inlinecode donthyphenate">f1*f2*f3*f4*f5*f6*f7*f8</span></span> is completely associative. On x87, 130 floats can be safely multiplied together in any order, and 16 doubles can similarly be multiplied together safely.
Strict distributivity does not hold even under these circumstances, as it may destroy the sign of -0.</li>
<li>The distributive law almost never holds. For example, <span class="notranslate"><span class="d_inlinecode donthyphenate">4*x + 6*x != 10*x</span></span> if <span class="notranslate"><span class="d_inlinecode donthyphenate">x==nextDown(1.5)</span></span>. <span class="notranslate"><span class="d_inlinecode donthyphenate">a*x + b*x == (a+b)*x</span></span> for all <span class="notranslate"><span class="d_inlinecode donthyphenate">x</span></span> only if the operations <span class="notranslate"><span class="d_inlinecode donthyphenate">a*x, b*x</span></span>, and <span class="notranslate"><span class="d_inlinecode donthyphenate">(a+b)</span></span> are all exact operations, which is true only if <span class="notranslate"><span class="d_inlinecode donthyphenate">a</span></span> and <span class="notranslate"><span class="d_inlinecode donthyphenate">b</span></span> are exact powers of 2. Even then, if <span class="notranslate"><span class="d_inlinecode donthyphenate">a==-b</span></span> and <span class="notranslate"><span class="d_inlinecode donthyphenate">x==-0</span></span>, then <span class="notranslate"><span class="d_inlinecode donthyphenate">a*x+b*x==0.0, (a+b)*x==-0.0</span></span>.</li>
<li>Performing a division by multiplication by the reciprocal returns a result which (in round-to-nearest mode) is at most 1.5 ulps from the correctly rounded result. For almost any denominator, the rounding is incorrect (&gt;0.5ulps) for 27% of numerators. [Ref: N. Brisebarre, J-M Muller, and S.K. Raina, "Accelerating Correctly Rounded Floating-Point Division when the Divisor Is Known in Advance", IEEE Trans. on Computers, Vol 53, pp 1069-1072 (2004)].</li>
</ul>


<h3> Powers and logarithms</h3>

<ul><li><span class="notranslate"><span class="d_inlinecode donthyphenate">F.mant_dig = -log2(F.epsilon)</span></span> for binary types;</li>
<li> <span class="notranslate"><span class="d_inlinecode donthyphenate">F.dig = -log10(F.epsilon)</span></span> for decimal types.</li>
<li><span class="notranslate"><span class="d_inlinecode donthyphenate">F.max =  exp2(F.max_exp*(1-F.epsilon))</span></span> for binary types;</li>
<li><span class="notranslate"><span class="d_inlinecode donthyphenate">F.max = exp10(F.max_10_exp*(1-F.epsilon))</span></span> for decimal types.</li>
<li>For any positive finite <span class="notranslate"><span class="d_inlinecode donthyphenate">x</span></span>, <span class="notranslate"><span class="d_inlinecode donthyphenate">F.min_exp - F.mant_dig &lt;= log2(x) &lt; F.max_exp</span></span> for binary types,
                             <span class="notranslate"><span class="d_inlinecode donthyphenate">F.min_10_exp - F.dig &lt;= log10(x) &lt; F.max_10_exp</span></span>  for decimal types</li>
<li><span class="notranslate"><span class="d_inlinecode donthyphenate">exp2(x) == 0</span></span> if <span class="notranslate"><span class="d_inlinecode donthyphenate">x &lt; F.min_exp - F.mant_dig</span></span>, <span class="notranslate"><span class="d_inlinecode donthyphenate">exp2(x) == infinity</span></span> if <span class="notranslate"><span class="d_inlinecode donthyphenate">x &gt;= F.max_exp</span></span></li>
</ul>

<h2>NaN payloads</h2>

<p>According to the IEEE 754 standard, a &lsquo;payload&rsquo; can be stored in the mantissa of a NaN. This payload can contain information about how or why it was generated. Historically, almost no programming languages have ever made use of this potentially powerful feature. In D, this payload consists of a positive integer.</p>

<ul><li><span class="notranslate"><span class="d_inlinecode donthyphenate">real NaN(ulong payload)</span></span> -- create a NaN with a "payload", where the payload is a <span class="notranslate"><span class="d_inlinecode donthyphenate">ulong</span></span>.</li>
<li><span class="notranslate"><span class="d_inlinecode donthyphenate">ulong getNaNPayload(real x)</span></span> -- returns the integer payload. Note that if narrowing conversions have occured, the high-order bits may have changed.</li>
</ul>

<p><i>Never</i> store a pointer as an integer payload inside a NaN. The garbage collector will not be able to find it!</p>

<h2>The IEEE Rounding Modes</h2>

<p>The rounding mode is controlled within a scope. Rounding mode will be restored to its previous state at the end of that scope.
Four rounding modes can be set. The default mode, <i>Round to nearest</i>, is the most statistically accurate, but the least intuitive. In the event of tie, the result is rounded to an even number.
</p>

<table border=1 cellpadding=4 cellspacing=0><tr><th scope="col">Rounding mode</th> <th scope="col">rndint(4.5)</th> <th scope="col">rndint(5.5)</th> <th scope="col">rndint(-4.5)</th> <th scope="col">Notes</th></tr>
<tr><td>Round to nearest</td> <td>4</td> <td>6</td> <td>-4</td> <td>Ties round to an even number</td></tr>
<tr><td>Round down</td> <td>4</td> <td>5</td> <td>-5</td> <td>&nbsp;</td></tr>
<tr><td>Round up</td> <td>5</td> <td>6</td> <td>-4</td> <td>&nbsp;</td></tr>
<tr><td>Round to zero</td> <td>4</td> <td>5</td> <td>-4</td> <td>&nbsp;</td></tr>
</table>

<p>There are very few reasons for changing the rounding mode.
The round-up and round-down modes were created specifically to allow fast implementations of interval arithmetic; they are crucial to certain libraries, but rarely used elsewhere.
The round-to-zero mode is used for casting floating-point numbers to integers. Since mode switching is slow, especially on Intel machines, it may be useful to switch to round-to-zero mode, in order to exactly duplicate the behaviour of <span class="notranslate"><span class="d_inlinecode donthyphenate">cast(int)</span></span> in an inner loop.
</p>

<p>The only other commonly cited reason for changing the rounding mode is as a simple check for numerical stability: if the calculation produces wildly different results when the rounding mode is changed, it's a clear sign that it is suffering from round-off errors. </p>

<h2>The IEEE Exception Status Flags</h2>

<p>All IEEE-compiliant processors include special status bits that indicate when "weird" things have happened that programs might want to know about. For example, <span class="notranslate"><span class="d_inlinecode donthyphenate">ieeeFlags.divideByZero</span></span> tells if any infinities have been created by dividing by zero. They are 'sticky' bits: once they have been set, they remain set until explicitly cleared. By only checking this once at the end of a calculation, it may be possible to avoid comparing thousands of comparisions that are almost never going to fail.</p>

<p>Here's a list of the weird things that can be detected:</p>

<dl><dt>invalid</dt> <dd>This is set if any NaN's have been generated. This can happen with &infin; - &infin;, &infin; * 0, 0 * &infin;, 0/0, &infin;/&infin;, &infin;%&infin;, or <span class="notranslate"><span class="d_inlinecode donthyphenate">x%0</span></span>, for any number <span class="notranslate"><span class="d_inlinecode donthyphenate">x</span></span>. Several other operations, such as sqrt(-1), can also generate a NaN. The <i>invalid</i> condition is also set when a 'signalling NaN' is accessed, indicating use of an uninitialized variable. This almost always indicates a programming error.</dd>

<dt>overflow</dt> <dd>Set if &infin; was generated by adding or multiplying two numbers that were so large that the sum was greater than <span class="notranslate"><span class="d_inlinecode donthyphenate">real.max</span></span>. This almost always indicates that the result is incorrect; and corrective action needs to be taken.</dd>

<dt>divisionByZero</dt> <dd>Set if &plusmn;&infin; was generated by dividing by zero. This usually indicates a programming error, but not always; some types of calculations return correct results even when division by zero occurs.
(For example, <span class="notranslate"><span class="d_inlinecode donthyphenate">1/(1+ 1/x) == 0</span></span> if <span class="notranslate"><span class="d_inlinecode donthyphenate">x == 0</span></span>). Note that division by a tiny, almost-zero number also produces an infinite result, but sets the overflow flag rather than the divisionByZero flag.
</dd>

<dt>underflow</dt> <dd>This happens if two numbers are subtracted or divided and are so tiny that the result lost precision because it was subnormal. Extreme underflow produces a zero result. Underflow almost never creates problems, and can usually be ignored.</dd>

<dt>inexact</dt> <dd>This indicates that rounding has occurred. Almost all floating point operations set this flag! It was apparently included in the hardware to support some arcane tricks used in the pioneering days of numerical analysis. It can always be ignored.</dd>
</dl>

<p>Floating-point traps can be enabled for any of the categories listed above. When enabled, a hardware exception will be generated.
This can be an invaluable debugging aid.
A more advanced usage, not yet supported on any platform(!) is to provide a nested function to be used as a hardware exception handler. This is most useful for the overflow and underflow exceptions.
</p>

<h2>Floating point and &lsquo;pure nothrow&rsquo;</h2>

<p>Every floating point operation, even the most trivial, is affected by the floating-point rounding state, and writes to the sticky flags. The status flags and control state are thus 'hidden variables', potentially affecting every <span class="notranslate"><span class="d_inlinecode donthyphenate">pure</span></span> function; and if the floating point traps are enabled, any floating point operation can generate a hardware exception.
D provides a facility for the floating-point control mode and exception flags to be usable in limited circumstances even when <span class="notranslate"><span class="d_inlinecode donthyphenate">pure</span></span> and <span class="notranslate"><span class="d_inlinecode donthyphenate">nothrow</span></span> functions are called.
</p>

<p>[TODO: I've made two proposals, but I haven't persauded Walter yet!].</p>

<h2>Conclusion</h2>

<p>Although D is a general-purpose programming language and supports many high-level concepts, it gives direct and convenient access to almost all features of modern floating-point hardware. This makes it an excellent language for development of robust, high-performance numerical code. It is also a language which encourages a deep understanding of the machine, making it fertile ground for innovation and for developing new algorithms.</p>



<h2>References and Further Reading</h2>

<ol><li><a href="http://docs.sun.com/source/806-3568/ncg_goldberg.html">"What Every Computer Scientist Should Know About Floating-Point Arithmetic"</a>
</li>
<li><a href="http://www.cs.berkeley.edu/~wkahan/ieee754status/754story.html">"An Interview with the Old Man of Floating-Point: Reminiscences elicited from William Kahan by Charles Severance"</a>
</li>
<li>N. Brisebarre, J-M Muller, and S.K. Raina, "Accelerating Correctly Rounded Floating-Point Division when the Divisor Is Known in Advance", IEEE Trans. on Computers, Vol 53, pp 1069-1072 (2004).
</li>
<li><a href="http://www.sonic.net/~jddarcy/Borneo/">"The Borneo language"</a>
</li>
</ol>


  
<div id="google_ad">
<!-- Google ad -->
<script type="text/javascript"><!--
/**/google_ad_client = "pub-5628673096434613";
/**/google_ad_width = 728;
/**/google_ad_height = 90;
/**/google_ad_format = "728x90_as";
/**/google_ad_channel ="3651639259";
/**/google_page_url = document.location;
//--></script>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div>
</div><!--/content-->



<div id="footernav">
<a href="http://forum.dlang.org/" title="User Forums">Forums</a> |
<a href="http://wiki.dlang.org/DocComments/FloatingPointInD" title="Read/write comments and feedback">Comments</a> |
<a href="http://digitalmars.com/advancedsearch.html" title="Search Digital Mars web site">Search</a> |
<a href="download.html" title="Download D">Downloads</a> |
<a href="/">Home</a>
</div>
<div id="copyright">

Copyright &copy; 1999-2017 by Digital Mars &reg;, All Rights Reserved |
Page generated by <a href="ddoc.html">Ddoc</a> on (no date time)
</div>
</body>
</html>
